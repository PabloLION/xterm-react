name: Compatibility Tests

on:
  workflow_dispatch:
    inputs:
      run_oldest:
        description: "Run the oldest-supported compatibility suite"
        type: boolean
        default: false
      run_latest:
        description: "Run the latest-supported compatibility suite"
        type: boolean
        default: true
  workflow_call:
    inputs:
      run_oldest:
        required: false
        type: boolean
        default: false
      run_latest:
        required: false
        type: boolean
        default: true
  release:
    types:
      - published
  push:
    tags:
      - "v*"

jobs:
  version-matrix:
    timeout-minutes: 60
    name: Compatibility smoke (${{ matrix.suite.label }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        suite:
          - label: oldest-supported
            runtime: node20
            react: 18.3.1
            typescript: 5.2.2
            eslint: 8.57.0
            prettier: 3.3.3
          - label: latest-supported
            runtime: node24
            react: 19.1.1
            typescript: 5.9.3
            eslint: 9.13.0
            prettier: 3.6.2
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: "9"

      - name: Verify pnpm
        run: pnpm --version

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ${{ matrix.suite.label }} compatibility smoke (React ${{ matrix.suite.react }} / TS ${{ matrix.suite.typescript }} / ESLint ${{ matrix.suite.eslint }} / Prettier ${{ matrix.suite.prettier }} / ${{ matrix.suite.runtime }})
        if: >-
          ${{
            (github.event_name == 'workflow_dispatch' &&
              (
                (matrix.suite.label == 'latest-supported' && github.event.inputs.run_latest == 'true') ||
                (matrix.suite.label == 'oldest-supported' && github.event.inputs.run_oldest == 'true')
              )
            ) ||
            (github.event_name == 'workflow_call' &&
              (
                (matrix.suite.label == 'latest-supported' && inputs.run_latest) ||
                (matrix.suite.label == 'oldest-supported' && inputs.run_oldest)
              )
            ) ||
            ((github.event_name == 'release' || github.event_name == 'push') &&
              matrix.suite.label == 'latest-supported')
          }}
        run: >
          pnpm run compat:matrix
          -- --runtime ${{ matrix.suite.runtime }}
          --linter eslint-prettier
          --react ${{ matrix.suite.react }}
          --typescript ${{ matrix.suite.typescript }}
          --eslint ${{ matrix.suite.eslint }}
          --prettier ${{ matrix.suite.prettier }}
